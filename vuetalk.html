<html>

<script src=https://unpkg.com/vue@2.3.3></script>
<script src=https://unpkg.com/axios/dist/axios.min.js></script>

<style>


    .contactlistitem {
    	border: 1px;
    	border-color: #000000;
    	color: #eeeeee;
    	margin: 2px;
    	background-color: #33aa66;
    	padding: 10px;
    	
    	font-family: Roboto, sans-serif;
    }
</style>

<body>

<div id=contactslist> 
  <div>
  <a v-on:click=openChat(contact.name) v-for="contact in contacts" >
     <div class=contactlistitem> {{ contact.name }} {{ contact.status }} </div>

     </a>
  </div>




<div v-for="username in Array.from(chat_sessions)">
   {{ username }} chat session   <a v-on:click=closeChat(username)>[X]</a>
   <div>
     <span v-for="msg in messages[username]"><pre>
       {{msg.dt}}:    {{msg.from}}   {{msg.msg}}</pre></span>

   </div>
   <div>
       <input type="text" v-model=messagesout[username]></input>
       <button v-on:click="send(username)"> Send </button>
   </div>
</div>


</div>
<script>
    var appContactList = new Vue({
        el: '#contactslist',
        data: {
            contacts: "",
            chat_sessions_set: new Set(),
            chat_sessions: [],
            messages: {"usera": ['asdfa','asdfa','asdfs']},
            messagesout: {"usera":"msg outbound"}
        },
        methods: {
            openChat: function (user) {
            	       var vm = this
    	               console.log('openchat with ' + user)
    	               vm.chat_sessions_set.add(user)
    	               vm.chat_sessions = Array.from(vm.chat_sessions_set)
    	               console.log(vm.chat_sessions)
            },
            closeChat: function(user) {
            	       var vm = this
            	       console.log('close chat with ' + user)
            	       vm.chat_sessions_set.delete(user)
            	       vm.chat_sessions = Array.from(vm.chat_sessions_set)
            	       console.log(vm.chat_sessions)

            },
            updateMessages: function () {
            	axios.all([axios.get("contacts.json",{withCredentials:true}), axios.get("messages.json",{withCredentials:true})])
        	    .then(function (contactsResp, messagesResp) { console.log("axios all complete") } )
            	axios.get('contacts.json',{withCredentials:true}).then(function (resp) { vm.contacts = resp.data })
            	// messages.json?for=user&correspondents=usera|userb
            	axios.get('messages.json',{withCredentials:true}).then(function (resp) { vm.messages = resp.data; console.log(vm.messages) })
            
            },
            sendMessage: function(recipient, msg) {
            	axios.post('send_message', {withCredentials:true, msg: msg})
            			.then(function (res) {
				        })
				        .catch(function (err) {
              				console.log("could not send message")
              			})
              			
            
            },
            send: function(username) {
            	var vm = this
            	console.log(username)
            	console.log(vm.messagesout[username])
            	vm.sendMessage(username, vm.messagesout[username])
            	vm.messagesout[username] = ""
            }



        },
        mounted: function () {
        	vm = this
        	vm.updateMessages()
        	function cycle() {
        		vm.updateMessages()
            	setTimeout(cycle, 1500)
        	}
        	cycle()
        	/*
            var config = {
			  headers: {'X-My-Custom-Header': 'Header-Value'}
			};

			axios.get('https://api.github.com/users/codeheaven-io', config);
			axios.post('/save', { firstName: 'Marlon' }, config);
			*/
        },
        
    })

</script>

<pre> 
Todos:
x-Refresh
x-Send messages
Go server
Hook up to ere
status. userActivity model that gets updated with last active time. status query then compares this with minus 5 minutes.
</pre>

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
TODO security ensure api only responds to logged in user
</body>
</html>